<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<title>Form Order + Pembayaran</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://js.stripe.com/v3/"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f6f9fc;
  padding: 20px;
}
.container {
  max-width: 550px;
  margin: auto;
  background: white;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
input, select, button {
  width: 100%;
  padding: 10px;
  margin: 6px 0;
  border-radius: 8px;
  border: 1px solid #ccc;
}
button {
  background: #3b82f6;
  color: white;
  cursor: pointer;
  transition: 0.2s;
}
button:hover {
  background: #2563eb;
}
#items-table td { padding: 4px 0; }
.total-box {
  font-size: 1.3rem;
  text-align: right;
  margin-top: 12px;
  font-weight: bold;
}
</style>
</head>

<body>
<div class="container">

<h2>Form Order</h2>

<label>Nama Pemesan</label>
<input id="name" placeholder="Nama lengkap" />

<label>Tanggal</label>
<input id="date" type="date" />

<hr>

<h3>Item</h3>

<table id="items-table" style="width:100%;">
<tbody id="items-body"></tbody>
</table>

<button id="add-item">+ Tambah Item</button>

<div class="total-box">
Total: Rp <span id="grand">0</span>
</div>

<hr>

<button id="saveOrder">Simpan Order</button>
<button id="payButton" style="display:none; margin-top:12px;">Bayar Sekarang</button>

</div>

<script type="module">
/* ---------------- FIREBASE INIT ---------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider }
  from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
import { getFirestore, collection, addDoc, updateDoc, doc, getDoc }
  from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

const firebaseConfig = {
  // ✅ GANTI DENGAN KONFIGURASI KAMU
    apiKey: "AIzaSyBk57WWCAV9PbUQBb_bj7mPtl09oNz7WnA",
    authDomain: "schesakra.firebaseapp.com",
    projectId: "schesakra",
    storageBucket: "schesakra.firebasestorage.app",
    messagingSenderId: "672537227977",
    appId: "1:672537227977:web:88b24f905c86eba7c05318",
    measurementId: "G-Q7HSM1LK98"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ---------------- LOGIN OTOMATIS ---------------- */
onAuthStateChanged(auth, async (user)=> {
  if (!user) await signInWithPopup(auth, new GoogleAuthProvider());
});

/* ---------------- ITEMS FORM ---------------- */
const itemsBody = document.getElementById("items-body");
const addItemBtn = document.getElementById("add-item");

function addItemRow() {
  const row = document.createElement("tr");
  row.innerHTML = `
    <td><input class="item-name" placeholder="Nama barang"></td>
    <td><input class="item-qty" type="number" placeholder="Qty" min="1" value="1"></td>
    <td><input class="item-price" type="number" placeholder="Harga"></td>
  `;
  itemsBody.appendChild(row);

  row.querySelector(".item-qty").addEventListener("input", updateTotal);
  row.querySelector(".item-price").addEventListener("input", updateTotal);
}
addItemRow();
addItemBtn.onclick = addItemRow;

function updateTotal() {
  let total = 0;
  document.querySelectorAll("#items-body tr").forEach(tr=>{
    const qty = Number(tr.querySelector(".item-qty").value) || 0;
    const price = Number(tr.querySelector(".item-price").value) || 0;
    total += qty * price;
  });
  document.getElementById("grand").textContent = total.toLocaleString();
}

/* ---------------- SIMPAN ORDER ---------------- */
let currentOrderId = null;
const saveBtn = document.getElementById("saveOrder");
const payBtn = document.getElementById("payButton");

saveBtn.onclick = async ()=>{
  const user = auth.currentUser;
  if (!user) return alert("User belum login!");

  const name = document.getElementById("name").value;
  const date = document.getElementById("date").value;
  const items = [];
  let grand = 0;

  document.querySelectorAll("#items-body tr").forEach(tr=>{
    const item = tr.querySelector(".item-name").value;
    const qty = Number(tr.querySelector(".item-qty").value);
    const price = Number(tr.querySelector(".item-price").value);
    if(item && qty>0 && price>0){
      items.push({ id:item, qty, price });
      grand += qty*price;
    }
  });

  const order = await addDoc(collection(db,"orders"),{
    name,
    date,
    items,
    grand,
    status:"new",
    ownerUid:user.uid
  });

  currentOrderId = order.id;
  payBtn.style.display = "block";
  alert("✅ Order disimpan!");
};

/* ---------------- PEMBAYARAN STRIPE ---------------- */
const stripe = Stripe("pk_test_xxxxxxxxxxxxxxxxxxxxxxxxx"); // ✅ GANTI PUNYA KAMU

payBtn.onclick = async ()=>{
  if (!currentOrderId) return alert("Simpan order dulu!");

  const token = await auth.currentUser.getIdToken();
  const res = await fetch("http://localhost:5000/api/create-payment-intent",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":"Bearer "+token
    },
    body: JSON.stringify({ orderId: currentOrderId })
  });

  const data = await res.json();
  const clientSecret = data.clientSecret;

  const { error } = await stripe.confirmCardPayment(clientSecret, {
    payment_method: { card: { token: "tok_visa" } } // akan otomatis muncul UI
  });

  if(error) alert("⚠️ " + error.message);
  else alert("✅ Pembayaran berhasil!");
};

</script>
</body>
</html>
