<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cookie Shop — Produk</title>
  <meta name="description" content="Daftar cookies & snack. Filter harga, tag, dan urutkan produk." />

  <style>
    :root{
      --accent:#c4553b;
      --muted:#6b7280;
      --bg:#f6f8fa;
      --card:#ffffff;
      --radius:12px;
      --max-width:1180px;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#111;line-height:1.4}
    .container{max-width:var(--max-width);margin:28px auto;padding:0 18px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#f8a07a);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:20px}
    nav ul{display:flex;gap:14px;list-style:none;padding:0;margin:0}
    nav a{color:var(--muted);text-decoration:none;font-weight:600}
    .actions{display:flex;gap:10px;align-items:center}
    .btn{background:var(--card);border:1px solid #e6e9ef;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border:0}
    .breadcrumb{font-size:13px;color:var(--muted);margin:10px 0 18px}

    .layout{display:grid;grid-template-columns:300px 1fr;gap:20px}
    /* Responsive */
    @media (max-width:900px){ .layout{grid-template-columns:1fr} .sidebar{order:2} .main{order:1} }

    .card{background:var(--card);border-radius:var(--radius);box-shadow:0 6px 18px rgba(12,20,40,0.06);padding:16px}

    /* Sidebar */
    .sidebar .section{margin-bottom:16px}
    .price-range{display:flex;gap:8px}
    .price-range input{flex:1;padding:8px;border-radius:8px;border:1px solid #e6e9ef}
    .tags{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .tag{padding:6px 10px;border-radius:999px;background:#f3f4f6;border:1px solid #eceff4;font-size:13px;cursor:pointer}
    .tag.active{background:var(--accent);color:#fff;border:0}

    /* Main area */
    .controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;gap:12px}
    .controls .left{color:var(--muted)}
    .sort-select{padding:8px;border-radius:8px;border:1px solid #e6e9ef}

    .products{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
    @media (max-width:1100px){.products{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:640px){.products{grid-template-columns:repeat(1,1fr)}}

    .product{border-radius:12px;overflow:hidden;background:var(--card);display:flex;flex-direction:column}
    .product img{width:100%;height:200px;object-fit:cover;display:block}
    .product .body{padding:12px;flex:1;display:flex;flex-direction:column}
    .product h4{margin:0 0 6px;font-size:16px}
    .price-row{margin-top:auto;display:flex;justify-content:space-between;align-items:center;gap:8px}
    .price{font-weight:700;color:var(--accent)}
    .add-cart{padding:8px 10px;border-radius:8px;border:0;background:#111;color:#fff;cursor:pointer}

    .pagination{display:flex;gap:8px;justify-content:center;margin-top:18px}
    .page-btn{padding:8px 12px;border-radius:8px;border:1px solid #e6e9ef;background:var(--card);cursor:pointer}
    .page-btn.active{background:var(--accent);color:#fff;border:0}

    footer{margin-top:28px;padding:18px 0;text-align:center;color:var(--muted);font-size:14px}
    /* small helpers */
    .muted{color:var(--muted);font-size:13px}

    /* CART DRAWER */
    .cart-drawer {
      position:fixed;
      right:0;
      top:0;
      height:100vh;
      width:420px;
      max-width:100%;
      transform:translateX(110%);
      transition:transform .28s ease;
      z-index:1200;
      padding:22px;
      box-shadow: -20px 0 40px rgba(12,20,40,0.12);
      background:var(--card);
      overflow:auto;
    }
    .cart-drawer.open { transform:translateX(0); }
    .cart-header {display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
    .cart-items {display:flex;flex-direction:column;gap:12px}
    .cart-item {display:flex;gap:12px;align-items:center;border-radius:10px;padding:8px;border:1px solid #f0f2f5}
    .cart-item img{width:72px;height:56px;object-fit:cover;border-radius:8px}
    .qty-controls{display:flex;gap:6px;align-items:center}
    .small{font-size:13px;color:var(--muted)}
    .summary{margin-top:12px;border-top:1px dashed #eef2f5;padding-top:12px}
    .checkout-form input, .checkout-form textarea {width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ef;margin-bottom:8px}
    .muted-note{font-size:13px;color:var(--muted);margin-top:8px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">CB</div>
        <div>
          <div style="font-weight:800;font-size:18px">Cookie Bakery</div>
          <div class="muted">Snacks untuk acara spesial</div>
        </div>
      </div>

      <nav>
        <ul>
          <li><a href="#">Home</a></li>
          <li><a href="#">Produk</a></li>
          <li><a href="#">Promo</a></li>
          <li><a href="#">Tentang</a></li>
          <li><a href="#">Outlet</a></li>
        </ul>
      </nav>

      <div class="actions">
        <button class="btn">Download Katalog</button>
        <button class="btn primary" id="cart-btn">Keranjang (0)</button>
      </div>
    </header>

    <div class="breadcrumb">Home / Cookies</div>

    <div class="layout">
      <!-- SIDEBAR -->
      <aside class="sidebar">
        <div class="card">
          <h3 style="margin:0 0 10px">Filter Harga</h3>
          <div class="section">
            <div class="price-range">
              <input type="number" id="minPrice" placeholder="Min (Rp)" />
              <input type="number" id="maxPrice" placeholder="Max (Rp)" />
            </div>
            <div style="margin-top:8px;display:flex;gap:8px">
              <button class="btn" id="apply-price">Filter</button>
              <button class="btn" id="clear-price">Reset</button>
            </div>
          </div>

          <hr style="border:none;border-top:1px solid #f0f2f5;margin:12px 0">

          <h3 style="margin:0 0 10px">Tags</h3>
          <div class="tags" id="tagContainer">
            <div class="tag" data-tag="manis">Manis</div>
            <div class="tag" data-tag="asin">Asin</div>
            <div class="tag" data-tag="keju">Keju</div>
            <div class="tag" data-tag="oreo">Oreo</div>
            <div class="tag" data-tag="kue">Kue</div>
            <div class="tag" data-tag="new">New</div>
          </div>

          <hr style="border:none;border-top:1px solid #f0f2f5;margin:12px 0">

          <h3 style="margin:0 0 10px">Kontak / Pesan</h3>
          <div class="muted">Isi formulir singkat untuk pemesanan.</div>
          <div style="margin-top:8px">
            <input id="quickNama" placeholder="Nama" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ef;margin-bottom:8px" />
            <input id="quickTelp" placeholder="Telepon" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ef;margin-bottom:8px" />
            <textarea id="quickPesan" placeholder="Pesan singkat" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ef"></textarea>
            <div style="margin-top:8px"><button class="btn primary">Kirim</button></div>
          </div>
        </div>
      </aside>

      <!-- MAIN -->
      <main class="main">
        <div class="card">
          <div class="controls">
            <div class="left">
              <span class="muted" id="resultCount">Menampilkan 12 produk</span>
            </div>
            <div>
              <select id="sort" class="sort-select">
                <option value="default">Urutan Normal</option>
                <option value="popular">Urutkan Berdasar Popularitas</option>
                <option value="latest">Sort by latest</option>
                <option value="price-asc">Harga: Rendah ke Tinggi</option>
                <option value="price-desc">Harga: Tinggi ke Rendah</option>
              </select>
            </div>
          </div>

          <div class="products" id="productsGrid">
            <!-- Produk akan di-render oleh JS -->
          </div>

          <div class="pagination" id="pagination">
            <!-- pagination -->
          </div>
        </div>
      </main>
    </div>

    <footer>
      © <span id="year"></span> Cookie Bakery — Semua hak cipta dilindungi.
    </footer>
  </div>

  <!-- CART DRAWER -->
  <aside id="cartDrawer" class="cart-drawer" aria-hidden="true">
    <div class="cart-header">
      <div>
        <h3 style="margin:0">Keranjang Anda</h3>
        <div class="small muted-note" id="cartCountText">0 item</div>
      </div>
      <div>
        <button class="btn" id="closeCart">Tutup</button>
      </div>
    </div>

    <div class="cart-items" id="cartItems"></div>

    <div class="summary">
      <div style="display:flex;justify-content:space-between"><div class="small">Subtotal</div><div id="subtotalText">Rp 0</div></div>
      <div style="display:flex;justify-content:space-between"><div class="small">Ongkir</div><div id="shippingText">Rp 0</div></div>
      <div style="display:flex;justify-content:space-between;font-weight:700;margin-top:8px"><div>Total</div><div id="totalText">Rp 0</div></div>

      <div style="margin-top:12px">
        <h4 style="margin:8px 0 6px">Formulir Checkout</h4>
        <form id="checkoutForm" class="checkout-form" onsubmit="return false;">
          <input id="custName" placeholder="Nama lengkap" required />
          <input id="custPhone" placeholder="Nomor telepon" required />
          <input id="custAddress" placeholder="Alamat pengiriman" required />
          <textarea id="custNote" placeholder="Catatan (opsional)"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" id="saveDraft">Simpan Draft</button>
            <button class="btn primary" id="checkoutBtn">Checkout & Kirim WA</button>
          </div>
        </form>
        <div class="muted-note">Setelah checkout, pesanan akan tersimpan di Firebase dan Anda akan diarahkan ke WhatsApp untuk konfirmasi/pembayaran.</div>
      </div>
    </div>
  </aside>

  <!-- Firebase + App Logic -->
  <script type="module">
    // -------------------------
    // Firebase initialization (modular v9)
    // -------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, push, set } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBk57WWCAV9PbUQBb_bj7mPtl09oNz7WnA",
      authDomain: "schesakra.firebaseapp.com",
      databaseURL: "https://schesakra-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "schesakra",
      storageBucket: "schesakra.firebasestorage.app",
      messagingSenderId: "672537227977",
      appId: "1:672537227977:web:88b24f905c86eba7c05318",
      measurementId: "G-Q7HSM1LK98"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // -------------------------
    // Existing product code (kept, hanya sedikit integrasi ke cart)
    // -------------------------
    const products = [
      {id:1,title:"Almond Bar Cookies",price:80000,tag:["manis"],img:"https://via.placeholder.com/600x400?text=Almond+Bar"},
      {id:2,title:"Cheese Pastry Stick Box",price:35000,tag:["keju"],img:"https://via.placeholder.com/600x400?text=Cheese+Stick"},
      {id:3,title:"Choco Pastry Stick Box",price:35000,tag:["choco"],img:"https://via.placeholder.com/600x400?text=Choco+Stick"},
      {id:4,title:"Sugar Palm Pastry",price:35000,tag:["manis"],img:"https://via.placeholder.com/600x400?text=Sugar+Palm"},
      {id:5,title:"Coklat Mente",price:80000,tag:["manis","oreo"],img:"https://via.placeholder.com/600x400?text=Coklat+Mente"},
      {id:6,title:"Katetong Keju",price:70000,tag:["keju"],img:"https://via.placeholder.com/600x400?text=Katetong+Keju"},
      {id:7,title:"Nastar Keju",price:95000,tag:["manis","keju"],img:"https://via.placeholder.com/600x400?text=Nastar+Keju"},
      {id:8,title:"Putri Salju",price:85000,tag:["manis"],img:"https://via.placeholder.com/600x400?text=Putri+Salju"},
      {id:9,title:"Vanilla Mente",price:80000,tag:["manis"],img:"https://via.placeholder.com/600x400?text=Vanilla+Mente"},
      {id:10,title:"Choco Oreo Cookies",price:70000,tag:["oreo","manis"],img:"https://via.placeholder.com/600x400?text=Choco+Oreo"},
      {id:11,title:"Kastengel",price:100000,tag:["keju"],img:"https://via.placeholder.com/600x400?text=Kastengel"},
      {id:12,title:"Cheese Corn",price:100000,tag:["keju"],img:"https://via.placeholder.com/600x400?text=Cheese+Corn"}
    ];

    // State
    let state = {
      products,
      filtered: [...products],
      page: 1,
      perPage: 9,
      cartCount: 0,
      activeTags: new Set(),
      minPrice: null,
      maxPrice: null
    };

    // Elements
    const productsGrid = document.getElementById('productsGrid');
    const resultCount = document.getElementById('resultCount');
    const pagination = document.getElementById('pagination');
    const cartBtn = document.getElementById('cart-btn');

    // Render products (kept dari file asli)
    function renderProducts(){
      const start = (state.page-1)*state.perPage;
      const end = start + state.perPage;
      const pageItems = state.filtered.slice(start,end);

      productsGrid.innerHTML = pageItems.map(p => `
        <article class="product card" data-id="${p.id}">
          <img src="${p.img}" alt="${escapeHtml(p.title)}" loading="lazy">
          <div class="body">
            <h4>${escapeHtml(p.title)}</h4>
            <div class="muted" style="font-size:13px">Tag: ${p.tag.join(', ')}</div>
            <div class="price-row">
              <div class="price">Rp ${numberWithCommas(p.price)}</div>
              <button class="add-cart" data-id="${p.id}">Tambah</button>
            </div>
          </div>
        </article>
      `).join('');

      resultCount.textContent = `Menampilkan ${state.filtered.length} produk`;
      renderPagination();
      attachAddCartEvents();
    }

    function renderPagination(){
      const total = Math.ceil(state.filtered.length / state.perPage) || 1;
      let html = '';
      for(let i=1;i<=total;i++){
        html += `<button class="page-btn ${i===state.page?'active':''}" data-page="${i}">${i}</button>`;
      }
      pagination.innerHTML = html;
      Array.from(pagination.querySelectorAll('.page-btn')).forEach(btn=>{
        btn.addEventListener('click',()=>{ state.page = Number(btn.dataset.page); renderProducts(); });
      });
    }

    function attachAddCartEvents(){
      Array.from(document.querySelectorAll('.add-cart')).forEach(btn=>{
        btn.addEventListener('click', e=>{
          const id = Number(btn.dataset.id);
          const product = products.find(p=>p.id===id);
          addToCart(product);
          btn.textContent = "✓";
          setTimeout(()=>btn.textContent = "Tambah",700);
        });
      });
    }

    // -------------------------
    // CART: localStorage + UI drawer
    // -------------------------
    function getCart(){
      return JSON.parse(localStorage.getItem("cart") || "[]");
    }
    function saveCart(cart){
      localStorage.setItem("cart", JSON.stringify(cart));
    }

    function addToCart(product){
      let cart = getCart();
      const index = cart.findIndex(item => item.id === product.id);
      if(index >= 0){
        cart[index].qty++;
      } else {
        cart.push({...product, qty: 1});
      }
      saveCart(cart);
      updateCartBadge(cart);
    }

    function updateCartBadge(cart){
      cartBtn.textContent = `Keranjang (${cart.reduce((s,i)=>s+i.qty,0)})`;
      document.getElementById('cartCountText').textContent = `${cart.length} item — ${cart.reduce((s,i)=>s+i.qty,0)} pcs`;
    }

    // Render cart drawer items
    function renderCartDrawer(){
      const cart = getCart();
      const container = document.getElementById('cartItems');
      if(cart.length === 0){
        container.innerHTML = `<div class="small">Keranjang kosong — tambahkan produk dulu.</div>`;
      } else {
        container.innerHTML = cart.map(item => `
          <div class="cart-item" data-id="${item.id}">
            <img src="${item.img}" alt="${escapeHtml(item.title)}" />
            <div style="flex:1">
              <div style="font-weight:700">${escapeHtml(item.title)}</div>
              <div class="small">Rp ${numberWithCommas(item.price)} / pcs</div>
              <div style="margin-top:8px;display:flex;align-items:center;justify-content:space-between">
                <div class="qty-controls">
                  <button class="btn qty-decr" data-id="${item.id}">-</button>
                  <div style="padding:6px 10px;border-radius:8px;background:#f6f7fb">${item.qty}</div>
                  <button class="btn qty-incr" data-id="${item.id}">+</button>
                </div>
                <div style="text-align:right">
                  <div style="font-weight:700">Rp ${numberWithCommas(item.price * item.qty)}</div>
                  <div style="margin-top:6px"><button class="btn" data-id="${item.id}" data-action="remove">Hapus</button></div>
                </div>
              </div>
            </div>
          </div>
        `).join('');
      }

      // totals
      const subtotal = cart.reduce((s,i)=>s + (i.price * i.qty), 0);
      const shipping = 0;
      const total = subtotal + shipping;
      document.getElementById('subtotalText').textContent = `Rp ${numberWithCommas(subtotal)}`;
      document.getElementById('shippingText').textContent = `Rp ${numberWithCommas(shipping)}`;
      document.getElementById('totalText').textContent = `Rp ${numberWithCommas(total)}`;

      // attach qty/remove events
      Array.from(document.querySelectorAll('.qty-incr')).forEach(b=>{
        b.addEventListener('click', () => {
          const id = Number(b.dataset.id);
          changeQty(id, +1);
        });
      });
      Array.from(document.querySelectorAll('.qty-decr')).forEach(b=>{
        b.addEventListener('click', () => {
          const id = Number(b.dataset.id);
          changeQty(id, -1);
        });
      });
      Array.from(document.querySelectorAll('button[data-action="remove"]')).forEach(b=>{
        b.addEventListener('click', () => {
          const id = Number(b.dataset.id);
          removeFromCart(id);
        });
      });
    }

    function changeQty(id, delta){
      const cart = getCart();
      const idx = cart.findIndex(i=>i.id===id);
      if(idx<0) return;
      cart[idx].qty = Math.max(1, cart[idx].qty + delta);
      saveCart(cart);
      renderCartDrawer();
      updateCartBadge(cart);
    }

    function removeFromCart(id){
      let cart = getCart();
      cart = cart.filter(i=>i.id !== id);
      saveCart(cart);
      renderCartDrawer();
      updateCartBadge(cart);
    }

    // Cart drawer open/close
    const cartDrawer = document.getElementById('cartDrawer');
    document.getElementById('cart-btn').addEventListener('click', ()=>{
      renderCartDrawer();
      cartDrawer.classList.add('open');
      cartDrawer.setAttribute('aria-hidden','false');
      document.body.style.overflow = 'hidden';
    });
    document.getElementById('closeCart').addEventListener('click', ()=>{
      cartDrawer.classList.remove('open');
      cartDrawer.setAttribute('aria-hidden','true');
      document.body.style.overflow = '';
    });

    // Initial badge update
    updateCartBadge(getCart());

    // -------------------------
    // Sorting / filters (kept)
    // -------------------------
    document.getElementById('sort').addEventListener('change', e=>{
      const v = e.target.value;
      if(v==='price-asc'){ state.filtered.sort((a,b)=>a.price-b.price); }
      else if(v==='price-desc'){ state.filtered.sort((a,b)=>b.price-a.price); }
      else if(v==='latest'){ state.filtered = state.filtered.slice().reverse(); }
      else if(v==='popular'){ /* placeholder */ }
      else { state.filtered = applyAllFilters(); }
      state.page = 1;
      renderProducts();
    });

    document.getElementById('tagContainer').addEventListener('click', e=>{
      const tagEl = e.target.closest('.tag');
      if(!tagEl) return;
      const t = tagEl.dataset.tag;
      if(state.activeTags.has(t)){ state.activeTags.delete(t); tagEl.classList.remove('active'); }
      else { state.activeTags.add(t); tagEl.classList.add('active'); }
      applyFiltersAndRender();
    });

    document.getElementById('apply-price').addEventListener('click',()=>{
      const min = Number(document.getElementById('minPrice').value) || null;
      const max = Number(document.getElementById('maxPrice').value) || null;
      state.minPrice = min;
      state.maxPrice = max;
      applyFiltersAndRender();
    });
    document.getElementById('clear-price').addEventListener('click',()=>{
      document.getElementById('minPrice').value = '';
      document.getElementById('maxPrice').value = '';
      state.minPrice = null;
      state.maxPrice = null;
      applyFiltersAndRender();
    });

    function applyAllFilters(){
      return products.filter(p=>{
        if(state.activeTags.size>0){
          const intersect = p.tag.some(t=>state.activeTags.has(t));
          if(!intersect) return false;
        }
        if(state.minPrice!=null && p.price < state.minPrice) return false;
        if(state.maxPrice!=null && p.price > state.maxPrice) return false;
        return true;
      });
    }
    function applyFiltersAndRender(){
      state.filtered = applyAllFilters();
      state.page = 1;
      document.getElementById('sort').value = 'default';
      renderProducts();
    }

    // -------------------------
    // CHECKOUT: save order to Firebase + generate invoice + open WhatsApp
    // -------------------------
    const checkoutBtn = document.getElementById('checkoutBtn');
    const saveDraftBtn = document.getElementById('saveDraft');

    // default phone from user (converted to +62)
    const sellerPhoneRaw = "0816772145";
    const sellerPhoneForWA = sellerPhoneRaw.replace(/^0/, "62"); // e.g. 0812 -> 62812
    const sellerPhoneForWaLink = sellerPhoneForWA; // used in wa.me link (no plus)

    // Utilities
    function numberWithCommas(x){ return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, "."); }
    function escapeHtml(text){ return String(text).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    // Create invoice and push order to Firebase
    async function submitOrder(saveOnly=false){
      const cart = getCart();
      if(cart.length === 0) { alert("Keranjang kosong."); return; }

      const name = document.getElementById('custName').value.trim();
      const phone = document.getElementById('custPhone').value.trim();
      const address = document.getElementById('custAddress').value.trim();
      const note = document.getElementById('custNote').value.trim();

      if(!name || !phone || !address){
        alert("Mohon isi Nama, Nomor telepon, dan Alamat pengiriman.");
        return;
      }

      // build order object
      const now = new Date();
      const invoiceNo = `INV-${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}-${now.getTime().toString().slice(-6)}`;
      const subtotal = cart.reduce((s,i)=>s + (i.price * i.qty), 0);
      const shipping = 0;
      const total = subtotal + shipping;

      const order = {
        invoiceNo,
        createdAt: now.toISOString(),
        customer: { name, phone, address, note },
        items: cart.map(ci=>({ id:ci.id, title:ci.title, price:ci.price, qty:ci.qty, lineTotal:ci.price*ci.qty })),
        subtotal,
        shipping,
        total,
        status: "pending"
      };

      try {
        // push to realtime db under /orders
        const ordersRef = ref(db, 'orders');
        const newOrderRef = await push(ordersRef);
        await set(newOrderRef, order);

        // if saveOnly then keep cart and just notify saved
        if(saveOnly){
          alert("Draft pesanan disimpan (Firebase). Invoice: " + invoiceNo);
          return;
        }

        // clear cart after successful save
        localStorage.removeItem('cart');
        updateCartBadge([]);
        renderCartDrawer();

        // build invoice text for WhatsApp (short)
        let waText = `Halo, saya ingin memesan dari Cookie Bakery.%0A`;
        waText += `Nomor Invoice: *${invoiceNo}*%0A`;
        waText += `Nama: ${encodeURIComponent(name)}%0A`;
        waText += `Telp: ${encodeURIComponent(phone)}%0A`;
        waText += `Alamat: ${encodeURIComponent(address)}%0A`;
        waText += `Catatan: ${encodeURIComponent(note || "-")}%0A%0A`;
        waText += `Pesanan:%0A`;
        order.items.forEach(it=>{
          waText += `${encodeURIComponent(it.qty)} x ${encodeURIComponent(it.title)} - Rp ${numberWithCommas(it.price*it.qty)}%0A`;
        });
        waText += `%0ASubtotal: Rp ${numberWithCommas(subtotal)}%0ATotal: Rp ${numberWithCommas(total)}%0A%0A`;
        waText += `Terima kasih.`;

        // also open printable invoice in new window
        const invoiceHtml = generateInvoiceHtml(order);
        const invWindow = window.open('', '_blank');
        invWindow.document.write(invoiceHtml);
        invWindow.document.close();

        // open wa link
        const waUrl = `https://wa.me/${sellerPhoneForWaLink}?text=${waText}`;
        // small delay to ensure invoice window opens first
        window.open(waUrl, '_blank');

        // close drawer
        cartDrawer.classList.remove('open');
        cartDrawer.setAttribute('aria-hidden','true');
        document.body.style.overflow = '';

      } catch (err) {
        console.error(err);
        alert("Gagal menyimpan pesanan ke Firebase. Cek console.");
      }
    }

    // save draft
    saveDraftBtn.addEventListener('click', async (e)=>{
      e.preventDefault();
      await submitOrder(true);
    });

    checkoutBtn.addEventListener('click', async (e)=>{
      e.preventDefault();
      await submitOrder(false);
    });

    // generate printable invoice HTML
    function generateInvoiceHtml(order){
      const itemsHtml = order.items.map(it=>`
        <tr>
          <td style="padding:8px;border-bottom:1px solid #eee">${escapeHtml(it.title)}</td>
          <td style="padding:8px;border-bottom:1px solid #eee;text-align:center">${it.qty}</td>
          <td style="padding:8px;border-bottom:1px solid #eee;text-align:right">Rp ${numberWithCommas(it.price)}</td>
          <td style="padding:8px;border-bottom:1px solid #eee;text-align:right">Rp ${numberWithCommas(it.lineTotal)}</td>
        </tr>
      `).join('');

      return `
        <html>
        <head>
          <meta charset="utf-8"/>
          <title>Invoice ${order.invoiceNo}</title>
        </head>
        <body style="font-family:Arial,Helvetica,sans-serif;color:#111;padding:24px">
          <h2>Invoice — Cookie Bakery</h2>
          <div>Invoice: <strong>${order.invoiceNo}</strong></div>
          <div>Tanggal: ${new Date(order.createdAt).toLocaleString()}</div>
          <hr style="margin:12px 0"/>
          <h4>Customer</h4>
          <div>${escapeHtml(order.customer.name)}</div>
          <div>${escapeHtml(order.customer.phone)}</div>
          <div>${escapeHtml(order.customer.address)}</div>
          <div style="margin-top:8px">Catatan: ${escapeHtml(order.customer.note || "-")}</div>

          <h4 style="margin-top:12px">Items</h4>
          <table style="width:100%;border-collapse:collapse">
            <thead>
              <tr><th style="text-align:left;padding:8px">Produk</th><th style="text-align:center;padding:8px">Qty</th><th style="text-align:right;padding:8px">Harga</th><th style="text-align:right;padding:8px">Jumlah</th></tr>
            </thead>
            <tbody>
              ${itemsHtml}
            </tbody>
          </table>

          <div style="margin-top:12px;display:flex;justify-content:flex-end">
            <div style="width:320px">
              <div style="display:flex;justify-content:space-between"><div>Subtotal</div><div>Rp ${numberWithCommas(order.subtotal)}</div></div>
              <div style="display:flex;justify-content:space-between"><div>Ongkir</div><div>Rp ${numberWithCommas(order.shipping)}</div></div>
              <hr/>
              <div style="display:flex;justify-content:space-between;font-weight:700"><div>Total</div><div>Rp ${numberWithCommas(order.total)}</div></div>
            </div>
          </div>

          <div style="margin-top:20px">Terima kasih telah memesan. Silakan lanjut konfirmasi di WhatsApp.</div>

          <div style="margin-top:18px">
            <button onclick="window.print()" style="padding:8px 12px;border-radius:8px;border:0;background:#222;color:#fff">Cetak PDF</button>
          </div>
        </body>
        </html>
      `;
    }

    // -------------------------
    // Init & utilities final
    // -------------------------
    document.getElementById('year').textContent = new Date().getFullYear();
    renderProducts();

    // keyboard shortcut: press "/" to focus first input
    window.addEventListener('keydown', e=>{
      if(e.key === '/') { e.preventDefault(); document.getElementById('minPrice').focus(); }
    });

  </script>
</body>
</html>
