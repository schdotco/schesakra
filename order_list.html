<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Menu Admin - Daftar Order</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial, sans-serif; background:#f0f4f8; padding:12px; margin:0; }
h2 { text-align:center; color:#1f2937; margin-bottom:10px; }
.table-box {
  background:white; padding:16px; border-radius:12px;
  box-shadow:0 4px 16px rgba(0,0,0,0.12);
  overflow-x:auto;
}
table { width:100%; border-collapse: collapse; font-size:14px; }
th, td { padding:10px; border-bottom:1px solid #ddd; text-align:left; }
th { background:#f3f4f6; font-weight:600; }
.order-row:hover { background:#e0ebff; cursor:pointer; }
.status-unpaid { color:#d00000; font-weight:bold; }
.status-paid { color:#007b1c; font-weight:bold; }
button.action-btn {
  background:#3b82f6; color:white; border:none; padding:6px 10px; border-radius:6px; cursor:pointer;
  font-size:13px; margin-right:4px; transition:0.2s;
}
button.action-btn:hover { background:#2563eb; }
button.rekap-btn {
  background:#10b981; color:white; border:none; padding:8px 14px; border-radius:8px; cursor:pointer;
  font-size:14px; margin-bottom:12px; transition:0.2s; display:block; margin-left:auto; margin-right:auto;
}
button.rekap-btn:hover { background:#059669; }
@media (max-width:480px){
  table, th, td { font-size:12px; }
  button.action-btn { padding:4px 8px; font-size:12px; }
  button.rekap-btn { padding:6px 12px; font-size:13px; }
}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getFirestore, collection, onSnapshot, doc, updateDoc } 
from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBk57WWCAV9PbUQBb_bj7mPtl09oNz7WnA",
  authDomain: "schesakra.firebaseapp.com",
  projectId: "schesakra",
  storageBucket: "schesakra.firebasestorage.app",
  messagingSenderId: "672537227977",
  appId: "1:672537227977:web:88b24f905c86eba7c05318"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const ordersBody = document.getElementById("orders");
const startDateInput = document.getElementById("startDate");
const endDateInput = document.getElementById("endDate");

let allOrders = []; // Menyimpan semua order

// Real-time listener
onSnapshot(collection(db, "orders"), snapshot => {
  allOrders = [];
  snapshot.forEach(docSnap => {
    const d = docSnap.data();
    allOrders.push({ id: docSnap.id, ...d });
  });
  applyDateFilter(); // Render langsung saat data diperbarui
});

// Fungsi render tabel
function renderOrders(orders) {
  ordersBody.innerHTML = "";
  orders.forEach(d => {
    const tr = document.createElement("tr");
    tr.classList.add("order-row");

    tr.innerHTML = `
      <td>${d.name}</td>
      <td>${d.date}</td>
      <td>Rp ${d.grand.toLocaleString()}</td>
      <td class="status-${d.status}">${d.status.toUpperCase()}</td>
      <td>
        <button class="action-btn" onclick="confirmOrder('${d.id}')">Konfirmasi</button>
        <button class="action-btn" onclick="markPaid('${d.id}')">Sudah Bayar</button>
      </td>
    `;

    tr.onclick = (e) => {
      if (e.target.tagName !== "BUTTON") {
        localStorage.setItem("selectedOrderId", d.id);
        window.location.href = "order_pay.html";
      }
    };

    ordersBody.appendChild(tr);
  });
}

// Update status menjadi "confirmed"
window.confirmOrder = async (id) => {
  const docRef = doc(db, "orders", id);
  await updateDoc(docRef, { status: "confirmed" });
  alert("✅ Order dikonfirmasi!");
};

// Update status menjadi "paid"
window.markPaid = async (id) => {
  const docRef = doc(db, "orders", id);
  await updateDoc(docRef, { status: "paid" });
  alert("✅ Status dibayar!");
};

// Tombol rekap
window.gotoRekap = () => {
  window.location.href = "rekaporder.html";
};

// Filter otomatis berdasarkan tanggal
window.applyDateFilter = () => {
  const start = startDateInput.value;
  const end = endDateInput.value;

  if (!start || !end) {
    renderOrders(allOrders); // Jika belum pilih tanggal, tampilkan semua
    return;
  }

  const filtered = allOrders.filter(o => o.date >= start && o.date <= end);
  renderOrders(filtered);
};

// Event listener otomatis saat tanggal berubah
startDateInput.addEventListener("change", applyDateFilter);
endDateInput.addEventListener("change", applyDateFilter);
</script>
</head>

<body>

<h2>Menu Admin - Daftar Order</h2>

<!-- Filter tanggal -->
<div style="text-align:center; margin-bottom:12px;">
  <label>Dari: <input type="date" id="startDate"></label>
  <label>Sampai: <input type="date" id="endDate"></label>
</div>

<!-- Tombol menuju rekap pesanan -->
<button class="rekap-btn" onclick="gotoRekap()">Lihat Rekap Pesanan</button>

<div class="table-box">
<table>
<thead>
<tr>
  <th>Nama</th>
  <th>Tanggal</th>
  <th>Total</th>
  <th>Status</th>
  <th>Aksi</th>
</tr>
</thead>
<tbody id="orders"></tbody>
</table>
</div>

</body>
</html>
